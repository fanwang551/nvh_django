# NVH 项目 Docker 部署指南

## 项目信息
- **项目地址**: https://github.com/fanwang551/nvh_django
- **数据库方案**: 方案1 (MySQL 8.0 容器化部署)
- **服务器IP**: 117.72.42.68

## 项目架构
- **前端**: Vue 3 + Vite + Element Plus + Pinia
- **后端**: Django 5.2.5 + Django REST Framework
- **数据库**: MySQL 8.0 (容器化)
- **反向代理**: NGINX
- **容器化**: Docker + Docker Compose

## 部署前准备

### 1. 服务器要求
- 操作系统: Linux (推荐 Ubuntu 20.04+/CentOS 7+)
- 内存: 至少 4GB
- 磁盘: 至少 20GB 可用空间
- 已安装 Docker 和 Docker Compose ✅ (已完成)
- 公网IP: 117.72.42.68

### 2. 安装 Docker (Ubuntu/Debian)
```bash
# 更新包索引
sudo apt update

# 安装 Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 安装 Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 启动 Docker 服务
sudo systemctl start docker
sudo systemctl enable docker

# 将当前用户添加到 docker 组
sudo usermod -aG docker $USER
```

### 3. 安装 Docker (CentOS/RHEL)
```bash
# 安装 Docker
sudo yum install -y yum-utils
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
sudo yum install -y docker-ce docker-ce-cli containerd.io

#
sudo systemctl start docker
sudo systemctl enable docker

# 安装 Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose
-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

## 部署步骤

### 1. 克隆项目到服务器
```bash
# 安装 Git (如果尚未安装)
sudo apt update && sudo apt install -y git

# 克隆项目到服务器
cd /opt
sudo git clone https://github.com/fanwang551/nvh_django.git

# 设置目录权限
sudo chown -R $USER:$USER /opt/nvh_django
cd /opt/nvh_django
```

### 2. 验证 Docker 环境
```bash
# 验证 Docker 安装
docker --version
docker-compose --version

# 启动 Docker 服务 (如果未启动)
sudo systemctl start docker
sudo systemctl enable docker

# 确保当前用户在 docker 组中
sudo usermod -aG docker $USER
# 重新登录或执行以下命令使组权限生效
newgrp docker
```

### 3. 配置环境变量
编辑 `.env.prod` 文件，修改以下重要配置：
```bash
# 复制环境变量模板
cp .env.prod .env.prod.backup

# 编辑环境变量文件
vim .env.prod
# 或使用 nano
nano .env.prod
```

**重要配置项（必须修改）：**
```bash
# Django 密钥（必须修改为随机字符串）
SECRET_KEY=nvh-production-secret-key-$(date +%s)-$(openssl rand -hex 16)

# 数据库配置（方案1：容器化 MySQL）
DB_NAME=nvh_database
DB_USER=nvh_user
DB_PASSWORD=nvh_secure_password_2024
DB_HOST=mysql
DB_PORT=3306

# MySQL Root 密码
MYSQL_ROOT_PASSWORD=nvh_root_secure_password_2024

# 服务器配置
ALLOWED_HOSTS=117.72.42.68,localhost,127.0.0.1
```

### 4. 初始化数据库数据（方案1）
根据项目需求，初始化必要的测试数据：
```bash
# 确保已在项目根目录
cd /opt/nvh_django

# 检查初始化脚本
ls -la backend/apps/*/management/commands/
```

### 5. 执行部署
```bash
# 确保在项目目录
cd /opt/nvh_django

# 给部署脚本执行权限
chmod +x deploy.sh

# 首次部署（包含完整构建）
./deploy.sh

# 等待所有服务启动完成
sleep 60
```

### 6. 初始化数据库和创建管理员
```bash
# 等待数据库服务完全启动
docker-compose -f docker-compose.prod.yml logs mysql

# 执行数据库迁移
docker-compose -f docker-compose.prod.yml exec backend python manage.py migrate

# 创建超级用户（管理员账户）
docker-compose -f docker-compose.prod.yml exec backend python manage.py createsuperuser

# 收集静态文件
docker-compose -f docker-compose.prod.yml exec backend python manage.py collectstatic --noinput

# 初始化测试数据（可选，根据项目需求）
# 模态数据
docker-compose -f docker-compose.prod.yml exec backend python manage.py init_modal_data
# 气密性数据
docker-compose -f docker-compose.prod.yml exec backend python manage.py init_airtightness_data
# 动态刚度数据
docker-compose -f docker-compose.prod.yml exec backend python manage.py init_dynamic_stiffness_data
```

### 7. 验证部署
**访问地址：**
- **前端应用**: http://117.72.42.68
- **API 接口**: http://117.72.42.68/api/
- **Django 管理后台**: http://117.72.42.68/admin/
- **健康检查**: http://117.72.42.68/health/

**验证步骤：**
```bash
# 检查所有服务状态
docker-compose -f docker-compose.prod.yml ps

# 检查端口监听
sudo netstat -tlnp | grep -E ':(80|443|3306)'

# 测试 API 连通性
curl -I http://117.72.42.68/api/
curl http://117.72.42.68/health/
```

## 常用管理命令

### 查看服务状态
```bash
docker-compose -f docker-compose.prod.yml ps
```

### 查看服务日志
```bash
# 查看所有服务日志
docker-compose -f docker-compose.prod.yml logs

# 查看特定服务日志
docker-compose -f docker-compose.prod.yml logs backend
docker-compose -f docker-compose.prod.yml logs nginx
docker-compose -f docker-compose.prod.yml logs mysql
```

### 重启服务
```bash
# 重启所有服务
docker-compose -f docker-compose.prod.yml restart

# 重启特定服务
docker-compose -f docker-compose.prod.yml restart backend
```

### 停止服务
```bash
docker-compose -f docker-compose.prod.yml down
```

### 更新应用
```bash
# 进入项目目录
cd /opt/nvh_django

# 备份当前环境变量
cp .env.prod .env.prod.backup.$(date +%Y%m%d_%H%M%S)

# 拉取最新代码
git stash  # 暂存本地修改
git pull origin main
git stash pop  # 恢复本地修改（如有冲突需手动解决）

# 停止服务
docker-compose -f docker-compose.prod.yml down

# 清理旧镜像（可选）
docker image prune -f

# 重新构建并启动
docker-compose -f docker-compose.prod.yml up --build -d

# 执行数据库迁移（如有新迁移）
docker-compose -f docker-compose.prod.yml exec backend python manage.py migrate

# 收集静态文件
docker-compose -f docker-compose.prod.yml exec backend python manage.py collectstatic --noinput
```

### 进入容器执行命令
```bash
# 进入后端容器
docker-compose -f docker-compose.prod.yml exec backend bash

# 执行 Django 管理命令
docker-compose -f docker-compose.prod.yml exec backend python manage.py createsuperuser
docker-compose -f docker-compose.prod.yml exec backend python manage.py migrate
docker-compose -f docker-compose.prod.yml exec backend python manage.py collectstatic
```

### 数据库管理

#### 备份数据库
```bash
# 创建备份目录
mkdir -p /opt/nvh_django/backups

# 创建数据库备份
docker-compose -f docker-compose.prod.yml exec mysql mysqldump -u nvh_user -p nvh_database > /opt/nvh_django/backups/nvh_backup_$(date +%Y%m%d_%H%M%S).sql

# 自动化备份脚本
echo '#!/bin/bash
cd /opt/nvh_django
docker-compose -f docker-compose.prod.yml exec mysql mysqldump -u nvh_user -p"nvh_secure_password_2024" nvh_database > /opt/nvh_django/backups/nvh_backup_$(date +%Y%m%d_%H%M%S).sql
find /opt/nvh_django/backups -name "nvh_backup_*.sql" -mtime +7 -delete' > /opt/nvh_django/backup.sh
chmod +x /opt/nvh_django/backup.sh

# 设置定时备份（每天凌晨2点）
(crontab -l 2>/dev/null; echo "0 2 * * * /opt/nvh_django/backup.sh") | crontab -
```

#### 恢复数据库
```bash
# 恢复数据库（请谨慎操作）
docker-compose -f docker-compose.prod.yml exec -T mysql mysql -u nvh_user -p nvh_database < /path/to/backup.sql
```

## SSL/HTTPS 配置（可选）

如果需要启用 HTTPS，请按以下步骤操作：

### 1. 获取 SSL 证书
- 使用 Let's Encrypt 免费证书
- 或购买商业 SSL 证书

### 2. 配置证书
将证书文件放置在 `ssl/` 目录下：
- `ssl/cert.pem` - 证书文件
- `ssl/key.pem` - 私钥文件

### 3. 启用 HTTPS 配置
编辑 `nginx/conf.d/default.conf`，取消注释 HTTPS 相关配置

## 故障排除

### 数据库方案1 特定问题

1. **MySQL 容器启动失败**
   ```bash
   # 检查 MySQL 容器日志
   docker-compose -f docker-compose.prod.yml logs mysql
   
   # 检查数据卷权限
   docker volume ls
   docker volume inspect nvh_django_mysql_data
   
   # 重新创建 MySQL 容器
   docker-compose -f docker-compose.prod.yml down
   docker volume rm nvh_django_mysql_data
   docker-compose -f docker-compose.prod.yml up -d mysql
   ```

2. **数据库连接超时**
   ```bash
   # 检查网络连通性
   docker-compose -f docker-compose.prod.yml exec backend ping mysql
   
   # 检查 MySQL 状态
   docker-compose -f docker-compose.prod.yml exec mysql mysql -u root -p -e "SHOW PROCESSLIST;"
   ```

### 常见问题及解决方案

1. **端口占用错误**
   ```bash
   # 检查端口占用
   sudo netstat -tlnp | grep :80
   sudo netstat -tlnp | grep :3306
   
   # 停止占用端口的服务
   sudo systemctl stop apache2  # 如果是 Apache
   sudo systemctl stop nginx    # 如果是系统 NGINX
   ```

2. **权限错误**
   ```bash
   # 确保 Docker 权限正确
   sudo usermod -aG docker $USER
   # 重新登录或执行
   newgrp docker
   ```

3. **内存不足**
   ```bash
   # 检查内存使用
   free -h
   
   # 清理不使用的 Docker 资源
   docker system prune -a
   ```

4. **网络连接问题**
   ```bash
   # 检查防火墙设置
   sudo ufw status
   sudo iptables -L
   
   # 开放必要端口
   sudo ufw allow 80
   sudo ufw allow 443
   
   # 检查 Docker 网络
   docker network ls
   docker-compose -f docker-compose.prod.yml exec backend nslookup mysql
   ```

5. **初始化数据失败**
   ```bash
   # 检查管理命令是否存在
   docker-compose -f docker-compose.prod.yml exec backend python manage.py help
   
   # 手动运行初始化命令
   docker-compose -f docker-compose.prod.yml exec backend python manage.py shell
   ```

6. **前端资源加载失败**
   ```bash
   # 检查 NGINX 配置
   docker-compose -f docker-compose.prod.yml exec nginx nginx -t
   
   # 重新构建前端
   docker-compose -f docker-compose.prod.yml build frontend
   ```

## 监控和维护

### 系统监控
```bash
# 实时监控容器资源使用
docker stats

# 监控服务器资源
free -h
df -h
top

# 检查服务健康状态
curl -f http://117.72.42.68/health/ || echo "Health check failed"
```

### 日志管理
```bash
# 查看实时日志
docker-compose -f docker-compose.prod.yml logs -f

# 查看特定时间段日志
docker-compose -f docker-compose.prod.yml logs --since="2024-01-01T00:00:00" --until="2024-01-02T00:00:00"

# 导出日志用于分析
docker-compose -f docker-compose.prod.yml logs > /tmp/nvh_logs_$(date +%Y%m%d).log

# 设置日志轮转
echo '{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}' | sudo tee /etc/docker/daemon.json
sudo systemctl restart docker
```

### 性能优化
```bash
# 清理不使用的资源
docker system prune -a --volumes

# 优化 MySQL 配置（已在 mysql/conf.d/my.cnf 中配置）
docker-compose -f docker-compose.prod.yml exec mysql mysql -u root -p -e "SHOW VARIABLES LIKE '%buffer_pool_size%';"

# 监控数据库性能
docker-compose -f docker-compose.prod.yml exec mysql mysql -u root -p -e "SHOW FULL PROCESSLIST;"
```

## 安全建议

1. **强化密码策略**: 确保所有密码都使用强密码
   ```bash
   # 生成安全密钥
   openssl rand -base64 32
   
   # 生成数据库密码
   openssl rand -base64 16
   ```

2. **防火墙配置**: 只开放必要的端口（80, 443）
   ```bash
   sudo ufw --force enable
   sudo ufw default deny incoming
   sudo ufw default allow outgoing
   sudo ufw allow ssh
   sudo ufw allow 80/tcp
   sudo ufw allow 443/tcp
   ```

3. **定期安全更新**:
   ```bash
   # 更新系统包
   sudo apt update && sudo apt upgrade -y
   
   # 更新 Docker 镜像
   docker-compose -f docker-compose.prod.yml pull
   docker-compose -f docker-compose.prod.yml up -d
   ```

4. **数据备份策略**: 设置自动化数据库备份
5. **SSL 证书**: 生产环境强烈建议使用 HTTPS
6. **访问控制**: 限制管理后台访问IP

## 项目特定配置

### NVH 系统初始化数据
项目包含多个业务模块的初始化命令：

```bash
# 模态分析模块
docker-compose -f docker-compose.prod.yml exec backend python manage.py init_modal_data

# 气密性测试模块
docker-compose -f docker-compose.prod.yml exec backend python manage.py init_airtightness_data
docker-compose -f docker-compose.prod.yml exec backend python manage.py init_airtightness_images

# 动态刚度模块
docker-compose -f docker-compose.prod.yml exec backend python manage.py init_dynamic_stiffness_data
docker-compose -f docker-compose.prod.yml exec backend python manage.py init_mount_isolation_data
docker-compose -f docker-compose.prod.yml exec backend python manage.py init_suspension_isolation_data
```

### 业务模块说明
- **模态分析**: 部件模态数据查询和对比
- **气密性测试**: 泄漏数据分析和图像查询
- **声学性能**: 隔声性能、混响数据、吸声系数等
- **动态刚度**: 悬架隔振、支撑隔振等测试数据

### API 端点测试
```bash
# 测试主要 API 端点
curl http://117.72.42.68/api/modal/components/
curl http://117.72.42.68/api/modal/vehicle-models/
curl http://117.72.42.68/api/sound/materials/
curl http://117.72.42.68/api/dynamic-stiffness/tests/
```

## 快速故障恢复

### 服务异常重启
```bash
#!/bin/bash
# 保存为 quick_recovery.sh
cd /opt/nvh_django

echo "开始快速恢复服务..."

# 停止所有服务
docker-compose -f docker-compose.prod.yml down

# 等待清理完成
sleep 10

# 启动核心服务
docker-compose -f docker-compose.prod.yml up -d mysql
sleep 30

docker-compose -f docker-compose.prod.yml up -d backend
sleep 20

docker-compose -f docker-compose.prod.yml up -d nginx

echo "服务恢复完成，请验证功能正常性"
```

## 联系信息
- **项目仓库**: https://github.com/fanwang551/nvh_django
- **问题反馈**: 请在 GitHub 仓库中提交 Issue
- **技术支持**: 联系项目维护团队

---

**部署完成检查清单：**
- [ ] Docker 环境正常
- [ ] 项目代码已克隆
- [ ] 环境变量已配置
- [ ] 数据库初始化完成
- [ ] 前端可正常访问
- [ ] API 接口响应正常
- [ ] 管理后台可访问
- [ ] 备份策略已设置
- [ ] 监控日志已配置

# 优化 MySQL 配置（已在 mysql/conf.d/my.cnf 中配置）
docker-compose -f docker-compose.prod.yml exec mysql mysql -u root -p -e "SHOW VARIABLES LIKE '%buffer_pool_size%';"

# 监控数据库性能
docker-compose -f docker-compose.prod.yml exec mysql mysql -u root -p -e "SHOW FULL PROCESSLIST;"
```

## 安全建议

1. **强化密码策略**: 确保所有密码都使用强密码
   ```bash
   # 生成安全密钥
   openssl rand -base64 32
   
   # 生成数据库密码
   openssl rand -base64 16
   ```

2. **防火墙配置**: 只开放必要的端口（80, 443）
   ```bash
   sudo ufw --force enable
   sudo ufw default deny incoming
   sudo ufw default allow outgoing
   sudo ufw allow ssh
   sudo ufw allow 80/tcp
   sudo ufw allow 443/tcp
   ```

3. **定期安全更新**:
   ```bash
   # 更新系统包
   sudo apt update && sudo apt upgrade -y
   
   # 更新 Docker 镜像
   docker-compose -f docker-compose.prod.yml pull
   docker-compose -f docker-compose.prod.yml up -d
   ```

4. **数据备份策略**: 设置自动化数据库备份
5. **SSL 证书**: 生产环境强烈建议使用 HTTPS
6. **访问控制**: 限制管理后台访问IP

## 项目特定配置

### NVH 系统初始化数据
项目包含多个业务模块的初始化命令：

```bash
# 模态分析模块
docker-compose -f docker-compose.prod.yml exec backend python manage.py init_modal_data

# 气密性测试模块
docker-compose -f docker-compose.prod.yml exec backend python manage.py init_airtightness_data
docker-compose -f docker-compose.prod.yml exec backend python manage.py init_airtightness_images

# 动态刚度模块
docker-compose -f docker-compose.prod.yml exec backend python manage.py init_dynamic_stiffness_data
docker-compose -f docker-compose.prod.yml exec backend python manage.py init_mount_isolation_data
docker-compose -f docker-compose.prod.yml exec backend python manage.py init_suspension_isolation_data
```

### 业务模块说明
- **模态分析**: 部件模态数据查询和对比
- **气密性测试**: 泄漏数据分析和图像查询
- **声学性能**: 隔声性能、混响数据、吸声系数等
- **动态刚度**: 悬架隔振、支撑隔振等测试数据

### API 端点测试
```bash
# 测试主要 API 端点
curl http://117.72.42.68/api/modal/components/
curl http://117.72.42.68/api/modal/vehicle-models/
curl http://117.72.42.68/api/sound/materials/
curl http://117.72.42.68/api/dynamic-stiffness/tests/
```

## 快速故障恢复

### 服务异常重启
```bash
#!/bin/bash
# 保存为 quick_recovery.sh
cd /opt/nvh_django

echo "开始快速恢复服务..."

# 停止所有服务
docker-compose -f docker-compose.prod.yml down

# 等待清理完成
sleep 10

# 启动核心服务
docker-compose -f docker-compose.prod.yml up -d mysql
sleep 30

docker-compose -f docker-compose.prod.yml up -d backend
sleep 20

docker-compose -f docker-compose.prod.yml up -d nginx

echo "服务恢复完成，请验证功能正常性"
```