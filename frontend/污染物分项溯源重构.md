📌 需求名称：实现整车物质追溯与关键零件排名接口（车身模块）
🔗 接口归属
模块路径：apps/vehicle_body/
前端页面：frontend/src/views/vehicle-data/SubstanceTraceability.vue
参考流程：可借鉴 apps/voc 模块的数据处理逻辑，但业务语义和接口命名需贴合“车身”场景。

🎯 功能目标

为前端组件 SubstanceTraceability.vue 提供一个 RESTful API 接口，用于支持以下功能：
根据用户选择的“项目名 - 委托单号 - 样品编号”组合（如 F123-1-1），查询该项目下所有相关物质信息；
用户从中选择若干物质后，系统返回这些物质在整车样品中的检测详情，并分别找出同一项目中非整车零件里该物质的 qij 和 wih 值最高的前5个零件。

此功能旨在实现从整车测试结果反向追溯到关键零部件贡献度的能力，聚焦于 VOC 全谱分析中的高影响物质。

🧩 输入条件解析规则

输入格式示例：F123-1-1
该字符串并非直接解析字段，而是表示一条样品记录的关键标识。其对应数据库字段如下：

输入部分 对应字段 查询条件
-------- -------- --------
F123 project_name 项目名称
1 test_order_no 检测委托单号 = '1'
1 sample_no 样品编号 = '1'

同时必须满足：
part_name = "整车"
该样品在 SubstancesTestDetail 表中存在至少一条物质测试数据

👉 即：通过这三个字段联合查询出唯一的“整车”样品记录。

📤 第一阶段输出：可选物质列表（下拉框数据源）

当成功匹配上述整车样品后，需加载其包含的所有物质，用于前端多选框展示。

数据来源：
关联 SubstancesTestDetail 表
过滤 sample__project_name, sample__test_order_no, sample__sample_no, sample__part_name="整车"

返回字段：
json
[
{
"cas_no": "100-42-5",
"chinese_name": "苯乙烯",
"english_name": "Styrene",
"concentration": "56.789"
},
...
]
✅ 支持多选多个物质进行后续分析。

📤 第二阶段输出：所选物质的详细信息及 Top 5 零件排名

用户选择一个或多个物质（以 CAS 号为唯一标识）后，执行以下操作：
1. 返回所选物质在整车样品中的检测详情

对每个选中的物质，返回其在该整车样品中的具体检测数据：

字段 来源
------ ------
保留时间 retention_time
匹配度 match_degree
浓度占比 concentration_ratio
浓度 concentration
2. 分别计算并返回该物质在同项目其他非整车零件中的 qij 和 wih 排名 Top 5
查询条件：
sample__project_name = {project_name}（与整车相同）
sample__part_name != "整车"（排除整车）
substance__cas_no = {selected_cas_no}（指定物质）
若同一零件（即 sample.part_name 相同）有多条记录，则仅保留 qij / wih 最大的那一条（去重）
输出要求：
对每个选中物质，返回两个独立的 Top 5 列表：
top_5_by_qij: 按 qij 降序排列，取前5
top_5_by_wih: 按 wih 降序排列，取前5
⚠️ 注意：即使同一个零件出现在两个榜单中，也允许重复出现。

📦 接口设计建议（RESTful）
🔹 接口1：获取可选物质列表（用于下拉框）
http
GET /api/vehicle-body/substance-traceability/substances/?project_name=F123&test_order_no=1&sample_no=1

响应示例：
json
{
"code": 200,
"data": [
{
"cas_no": "100-42-5",
"chinese_name": "苯乙烯",
"english_name": "Styrene",
"concentration": "56.789"
},
{
"cas_no": "110-82-7",
"chinese_name": "正己烷",
"english_name": "n-Hexane",
"concentration": "120.450"
}
]
}

🔹 接口2：获取所选物质详情及其 Top 5 零件排名
http
POST /api/vehicle-body/substance-traceability/ranking/

请求体（JSON）：
json
{
"project_name": "F123",
"test_order_no": "1",
"sample_no": "1",
"selected_substances": ["100-42-5", "110-82-7"]
}

响应示例：
json
{
"code": 200,
"data": [
{
"cas_no": "100-42-5",
"chinese_name": "苯乙烯",
"english_name": "Styrene",
"in_vehicle": {
"retention_time": "5.3210",
"match_degree": 95.67,
"concentration_ratio": 12.345,
"concentration": "56.789"
},
"top_5_by_qij": [
{
"part_name": "仪表板",
"qij": "8.76",
"wih": "3.21",
"concentration": "45.678"
},
{
"part_name": "车门内饰板",
"qij": "7.89",
"wih": "2.98",
"concentration": "38.450"
}
],
"top_5_by_wih": [
{
"part_name": "座椅泡沫",
"qij": "6.54",
"wih": "9.01",
"concentration": "67.890"
},
{
"part_name": "顶棚材料",
"qij": "5.32",
"wih": "8.45",
"concentration": "62.340"
}
]
}
]
}

💡 数据处理逻辑说明

1. 自动计算字段：
qij = concentration / odor_threshold （来自 Substance 模型）
wih = concentration / organic_threshold

2. 去重策略：
在聚合零件时，使用 (project_name, part_name, cas_no) 作为维度。
若某零件有多个测试样本，取其中 qij 或 wih 的最大值参与排序。

3. 性能建议：
使用数据库级聚合（如 Django ORM 的 annotate + Max）避免内存中处理。
添加适当索引（已存在 project_name, part_name, sample_no 等索引）。

✅ 前端兼容性要求
保持现有 UI 不变，仅需后端提供符合预期结构的 JSON 数据。
所有字段命名与类型需与前端定义一致（建议统一使用 snake_case）。



