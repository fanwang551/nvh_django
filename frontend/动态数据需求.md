
# 稳态数据分析功能需求文档

## 一、功能概述

在业务中心"其他"分类下新增"稳态数据分析"功能，用于多测点、多工况的对比分析。

**文件位置：**
- 前端：`frontend/src/views/business/SteadyStateAnalysis.vue`
- 后端：`backend/apps/acoustic_analysis/`

---

## 二、数据模型

### 2.1 数据库表结构

#### ConditionMeasurePoint（工况测点维度表）
```python
class ConditionMeasurePoint(models.Model):
    work_condition = models.CharField(max_length=100, verbose_name='工况')
    measure_point = models.CharField(max_length=100, verbose_name='测点')
    measure_type = models.CharField(
        max_length=20,
        choices=MeasureType.choices,
        verbose_name='测点类型'
    )
    
    class MeasureType(models.TextChoices):
        NOISE = 'noise', '噪声'
        VIBRATION = 'vibration', '振动'
        SPEED = 'speed', '转速'
```

#### AcousticTestData（声学测试数据表）
```python
class AcousticTestData(models.Model):
    """声学测试数据表（频谱、总声压级等）"""

    vehicle_model = models.ForeignKey(
        'modal.VehicleModel',
        on_delete=models.CASCADE,
        related_name='acoustic_test_data',
        verbose_name='车型信息'
    )

    condition_point = models.ForeignKey(
        'acoustic_analysis.ConditionMeasurePoint',
        on_delete=models.PROTECT,
        related_name='test_data',
        verbose_name='工况测点'
    )

    # 频谱数据（约12000个数据点）
    # 格式：{"frequency": [...], "dB": [...]}
    spectrum_json = models.JSONField(null=True, blank=True, verbose_name='频谱数据JSON')

    # 总声压级数据（约20个数据点）
    # 格式：{"time": [...], "OA": [...]}
    oa_json = models.JSONField(null=True, blank=True, verbose_name='总声压级JSON')

    # 语音清晰度与有效值
    speech_clarity = models.DecimalField(max_digits=10, decimal_places=4, null=True, blank=True, verbose_name='语音清晰度')
    rms_value = models.DecimalField(max_digits=10, decimal_places=4, null=True, blank=True, verbose_name='有效值')

    test_date = models.DateField(null=True, blank=True, verbose_name='测试日期')
```
```
字段说明：
1. vehicle_model (外键)
2. condition_point (外键)
3. spectrum_json (频谱数据)
4. oa_json (总声压级/振动时域) - 噪声和振动使用
5. speech_clarity (语音清晰度) - 仅噪声使用
6. rms_value (有效值) - 噪声、振动、转速都使用
7. test_date (测试日期)

存储规则：
- 噪声测点：存储 spectrum_json、oa_json、speech_clarity、rms_value
- 振动测点：存储 spectrum_json、oa_json(作为振动时域)、rms_value
- 转速测点：存储rms_value
```
### 2.2 数据类型与字段映射

| 测点类型 | 使用字段 | 数据格式 | 单位 |
|---------|---------|---------|------|
| **噪声** | `rms_value` | Decimal | dB(A) |
|  | `speech_clarity` | Decimal | % |
| **振动** | `rms_value` | Decimal | m/s² |
| **转速** | `rpm` | Integer | rpm |

> **注意：** 本功能仅使用特征值字段（rms_value、speech_clarity、rpm），不使用频谱数据（spectrum_json和oa_json）

---

## 三、功能需求

### 3.1 界面布局

```
┌─────────────────────────────────────────┐
│          筛选条件区域                    │
│车型: [] 工况: []  测点: [] [查询] [重置]   │
├─────────────────────────────────────────┤
│          图表展示区域（2列布局）          │
│  ┌─────────────┐  ┌─────────────┐      │
│  │   图表1     │  │   图表2     │      │
│  └─────────────┘  └─────────────┘      │
│  ┌─────────────┐  ┌─────────────┐      │
│  │   图表3     │  │   图表4     │      │
│  └─────────────┘  └─────────────┘      │
└─────────────────────────────────────────┘
```

**参考界面：** `AcousticAnalysis.vue` 的筛选框样式

### 3.2 筛选逻辑

| 筛选项 | 类型 | 说明 |
|-------|------|------|
| 车型 | 多选 | 必选项 |
| 工况 | 多选 | 必选项 |
| 测点 | 多选 | 可同时选择噪声/振动/转速测点 |

### 3.3 图表生成规则

#### 3.3.1 数据分组逻辑

根据**测点类型**和**指标类型**自动分组生成图表：

| 测点类型 | 指标 | 图表标题示例 | Y轴单位 |
|---------|------|-------------|--------|
| 噪声 | RMS | 噪声有效值对比 | dB(A) |
| 噪声 | 语音清晰度 | 语音清晰度对比 | % |
| 振动 | RMS | 振动有效值对比 | m/s² |
| 转速 | RPM | 转速对比 | rpm |

#### 3.3.2 图表配置

**通用配置：**
- X轴：工况名称（如：压缩机双开1档、压缩机双开2档...）
- Y轴：对应指标值
- 图例：车型-测点名称
- 每个图表可包含多条曲线（不同车型-测点）

**示例场景：**

**用户选择：**
- 工况：9个（压缩机双开1档、2档、3档...）
- 测点：6个
  - 车前0.5米（噪声）
  - 车前1.65米（噪声）
  - 压缩机本体Y（振动）
  - 压缩机本体Z（振动）
  - 压缩机转速（转速）
  - 电子扇转速（转速）

**生成图表：**

```
图表1: 噪声有效值对比 (dB(A))
├─ 曲线1: 车前0.5米
└─ 曲线2: 车前1.65米

图表2: 语音清晰度对比 (%)
├─ 曲线1: 车前0.5米
└─ 曲线2: 车前1.65米

图表3: 振动有效值对比 (m/s²)
├─ 曲线1: 压缩机本体Y
└─ 曲线2: 压缩机本体Z

图表4: 转速对比 (rpm)
├─ 曲线1: 压缩机转速
└─ 曲线2: 电子扇转速
```

---


**分组规则：**
- 同一数据类型的同一指标在同一图表中展示
- 不同数据类型或不同指标分别展示在不同图表中
- 每个图表中可包含多条曲线（不同测点）


---


选择"吉利星愿 2025UP 410KM探索版"车型——>"idle AC on" "鹅卵石路40kph"——>"驾驶员右耳"等噪声数据测点时
报错；但是同一车型的其他数据类型不会报错；其他车型的噪声数据也能正常加载；只有车id=1且工况测点类型为noise的数据报错。
报错为：“Internal Server Error: /api/acoustic-analysis/steady-state/query/
Traceback (most recent call last):
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\django\db\backends\utils.py", line 105, in _execute
    return self.cursor.execute(sql, params)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\django\db\backends\mysql\base.py", line 76, in execute
    return self.cursor.execute(query, args)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
             ^^^^^^^^^^^^^^^^^^
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\pymysql\connections.py", line 558, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\pymysql\connections.py", line 822, in _read_query_result
    result.read()
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\pymysql\connections.py", line 1207, in read
    self._read_result_packet(first_packet)
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\pymysql\connections.py", line 1284, in _read_result_packet
    self._read_rowdata_packet()
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\pymysql\connections.py", line 1331, in _read_rowdata_packet
    packet = self.connection._read_packet()
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\pymysql\connections.py", line 772, in _read_packet
    packet.raise_for_error()
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\pymysql\protocol.py", line 221, in raise_for_error
    err.raise_mysql_exception(self._data)
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\pymysql\err.py", line 143, in raise_mysql_exception
    raise errorclass(errno, errval)
pymysql.err.OperationalError: (1038, 'Out of sort memory, consider increasing server sort buffer size')

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\django\core\handlers\exception.py", line 55, in inner
    response = get_response(request)
               ^^^^^^^^^^^^^^^^^^^^^
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\django\core\handlers\base.py", line 197, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\django\views\decorators\csrf.py", line 65, in _view_wrapper
    return view_func(request, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\django\views\generic\base.py", line 105, in view
    return self.dispatch(request, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\rest_framework\views.py", line 509, in dispatch
    response = self.handle_exception(exc)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\rest_framework\views.py", line 469, in handle_exception
    self.raise_uncaught_exception(exc)
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\rest_framework\views.py", line 480, in raise_uncaught_exception
    raise exc
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\rest_framework\views.py", line 506, in dispatch
    response = handler(request, *args, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\rest_framework\decorators.py", line 50, in handler
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "D:\pythonProject\zlbbses\nvh_django\backend\apps\acoustic_analysis\views.py", line 321, in query_steady_state_data
    for obj in qs:
               ^^
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\django\db\models\query.py", line 384, in __iter__
    self._fetch_all()
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\django\db\models\query.py", line 1949, in _fetch_all
    self._result_cache = list(self._iterable_class(self))
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\django\db\models\query.py", line 91, in __iter__
    results = compiler.execute_sql(
              ^^^^^^^^^^^^^^^^^^^^^
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\django\db\models\sql\compiler.py", line 1623, in execute_sql
    cursor.execute(sql, params)
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\django\db\backends\utils.py", line 122, in execute
    return super().execute(sql, params)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\django\db\backends\utils.py", line 79, in execute
    return self._execute_with_wrappers(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\django\db\backends\utils.py", line 92, in _execute_with_wrappers
    return executor(sql, params, many, context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\django\db\backends\utils.py", line 100, in _execute
    with self.db.wrap_database_errors:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\django\db\utils.py", line 91, in __exit__
    raise dj_exc_value.with_traceback(traceback) from exc_value
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\django\db\backends\utils.py", line 105, in _execute
    return self.cursor.execute(sql, params)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\django\db\backends\mysql\base.py", line 76, in execute
    return self.cursor.execute(query, args)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\pymysql\cursors.py", line 153, in execute
    result = self._query(query)
             ^^^^^^^^^^^^^^^^^^
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\pymysql\cursors.py", line 322, in _query
    conn.query(q)
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\pymysql\connections.py", line 558, in query
    self._affected_rows = self._read_query_result(unbuffered=unbuffered)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\pymysql\connections.py", line 822, in _read_query_result
    result.read()
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\pymysql\connections.py", line 1207, in read
    self._read_result_packet(first_packet)
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\pymysql\connections.py", line 1284, in _read_result_packet
    self._read_rowdata_packet()
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\pymysql\connections.py", line 1331, in _read_rowdata_packet
    packet = self.connection._read_packet()
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\pymysql\connections.py", line 772, in _read_packet
    packet.raise_for_error()
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\pymysql\protocol.py", line 221, in raise_for_error
    err.raise_mysql_exception(self._data)
  File "D:\pythonProject\zlbbses\nvh_django\backend\.venv\Lib\site-packages\pymysql\err.py", line 143, in raise_mysql_exception
    raise errorclass(errno, errval)
django.db.utils.OperationalError: (1038, 'Out of sort memory, consider increasing server sort buffer size')
[17/Nov/2025 17:22:04] "POST /api/acoustic-analysis/steady-state/query/ HTTP/1.1" 500 275157

”
其中数据库信息为"condition_measure_point.id, condition_measure_point.measure_point, condition_measure_point.work_condition
1	驾驶员右耳	idle AC on
2	二排右后左耳	idle AC on
3	驾驶员右耳	鹅卵石路40kph
4	二排右后左耳	鹅卵石路40kph
5	驾驶员右耳	鹅卵石路60kph
6	二排右后左耳	鹅卵石路60kph
7	驾驶员右耳	光滑沥青路60kph
8	二排右后左耳	光滑沥青路60kph
9	驾驶员右耳	光滑沥青路80kph
10	二排右后左耳	光滑沥青路80kph
11	驾驶员右耳	光滑沥青路100kph
12	二排右后左耳	光滑沥青路100kph
13	驾驶员右耳	光滑沥青路120kph
14	二排右后左耳	光滑沥青路120kph"

"test_data_all.condition_point_id, test_data_all.rms_value, test_data_all.speech_clarity,test_data_all.vehicle_model_id
1	39.9000	99.9000	1
2	38.3000	99.9000	1
3	64.6000	92.9000	1
4	66.9000	90.8000	1
5	68.8000	86.6000	1
6	71.1000	82.5000	1
7	55.2000	95.7000	1
8	57.6000	94.1000	1
9	60.3000	90.8000	1
10	62.1000	86.2000	1
11	64.1000	81.4000	1
12	65.6000	75.1000	1
13	68.1000	67.4000	1
14	69.0000	63.0000	1"