
### 2.1 目标
在现有 Django + Vue 项目中实现模块：**试验任务管理（NVH Task）**，满足“列表 + 统一抽屉 Tabs + 闭环提示条”的闭环流程。

### 2.2 非目标（明确不做）
- 不需要编写自动化测试。
- **最终提交中不包含 migration 文件**
- 不做额外的权限体系重构（只按“前端白名单行内编辑”要求实现最小权限体验）。

### 2.3 项目上下文（已知信息/强约束）
1. 前端 UI：Element Plus。
2. 前端 API 封装目录：`frontend/src/api`（必须沿用项目现有请求封装，不自建 axios 实例）。
3. 安排人员白名单（前端权限控制）：`['w1234','w1235']`，判断方式：`username in whitelist`。
4. 列表筛选字段必须包含：车型 / VIN / 加入预警系统 / 合同号 / 时间范围 / 任务提出人 / 测试人员 / 是否闭环。
5. 软删除：默认查询只返回未删除数据；destroy 必须走 soft_delete，不得物理删除。
6. `MainRecord.is_closed`：**只能在 submit/unsubmit/更换(解绑) entry_exit 时刷新一次并落库**；列表页只读该字段，不实时计算。
7. status 仅使用字符串常量：`DRAFT|SUBMITTED`（后端不加 choices）。
8. settings media：`MEDIA_URL = '/media/'`，`MEDIA_ROOT = os.path.join(BASE_DIR, 'media')`。

### 2.4 后端交付物（Django + DRF）
新增 app：`backend/apps/nvh_task/`，必须包含：
- `apps.py` / `models.py` / `serializers.py` / `services.py` / `views.py` / `urls.py`（以及必要的 `__init__.py`）
- 加入 `INSTALLED_APPS`
- 挂载总路由前缀：`/api/nvh-task/`

### 2.5 数据模型（字段/关系以此为准；允许按约束做纠偏）

#### 2.5.1 软删除基类（所有业务模型必须继承）
- `SoftDeleteModel`：`is_deleted` + `deleted_at` + 默认 manager 过滤 `is_deleted=False`
- 任何 `delete()` 调用都应走软删除

#### 2.5.2 状态常量（字符串）
- `STATUS_DRAFT = "DRAFT"`
- `STATUS_SUBMITTED = "SUBMITTED"`

#### 2.5.3 业务模型关系
- `MainRecord` 关联 `EntryExit`：`ForeignKey`（可空，EntryExit 允许被多个 MainRecord 共用）
- `MainRecord` ↔ `TestInfo`：`OneToOne`
- `MainRecord` ↔ `DocApproval`：`OneToOne`
- `TestInfo` ↔ `TestProcessAttachment`：`ForeignKey`（过程记录附件列表）
- `TestProcessList`：过程记录表名的字典表（用于下拉/输入即新增）

#### 2.5.4 业务模型字段（关键字段）
以 `frontend/试验流程数字化需求最终版.md` 中的模型片段为基础实现，字段名必须保持一致，重点包括：
- `MainRecord`：`model`、`vin_or_part_no`、`test_name`、`warning_system_status`、`requester_name`、`schedule_start/schedule_end`、`tester_name`、`contract_no`、`entry_exit`、`is_closed`、`closure_checked_at`
- `EntryExit`：`receiver_name`、`enter_time`、`dispose_type/disposer_name/dispose_time/return_receiver`、`remark`、`status`
- `TestInfo`：联系方式/管理号/阶段/送件部门/报告联动字段/关键勾选字段/`teardown_attachment_url`/`status/submitted_at`
- `TestProcessAttachment`：`record_name`、`file_url`、`sort_no`
- `DocApproval`：名称/编号/数量/接收人/发放人/批准人/发放日期/`file_url`/`status/submitted_at`

#### 2.5.5 ImageField 约束（强制）
模型里 `file_url`、`teardown_attachment_url` 等字段必须是 `models.ImageField(...)`，并且：
- `upload_to` **必须统一在** `nvh_task/` 子目录下（例如 `nvh_task/teardown_record/`、`nvh_task/nvh_test_process/`、`nvh_task/nvh_task_approval/`）
- serializer 需做到：
  - 读：返回可访问 URL（或相对路径 + MEDIA_URL 可拼接）
  - 写：允许前端传“字符串相对路径/URL/空”时不崩溃

### 2.6 闭环规则（强制，写在 services 并被 views 调用）
闭环定义：
```
is_closed =
    (entry_exit 存在且 status == SUBMITTED)
AND (test_info 存在且 status == SUBMITTED)
AND (doc_approval 存在且 status == SUBMITTED)
```
触发闭环刷新的唯一允许时机：
- submit 成功
- unsubmit 成功
- `MainRecord` PATCH 更换/解绑 `entry_exit`

共享对象刷新（强制）：
- `EntryExit` submit/unsubmit：刷新其所有引用的 `MainRecord.is_closed`

### 2.7 提交校验（后端必须兜底）
- TestInfo submit：
  1) `include_teardown_record == "是"` → `teardown_attachment_url` 必须有
  2) `include_process_record == "是"` → 至少 1 条未软删 `TestProcessAttachment`
  3) `report_required == "否"` → `report_no` 必须为 `/`（否则 400）
- DocApproval submit：`file_url` 必须有
- EntryExit submit：实现“关键字段最小校验”（在代码中写明选择了哪些字段作为必填）

### 2.8 后端 API 合同（集中版）
以 `/api/nvh-task/` 为前缀，至少提供：
- MainRecord：list（分页 + 必须筛选字段）、create、retrieve、partial_update（含 `entry_exit_id` 变化触发闭环刷新）、destroy（soft_delete）
- EntryExit：CRUD、destroy（引用>1 需返回 400 可读错误）、submit/unsubmit
- TestInfo：`GET main-records/{id}/test-info/`（get_or_create DRAFT）、update、submit/unsubmit
- DocApproval：`GET main-records/{id}/doc-approval/`（get_or_create DRAFT）、update、submit/unsubmit
- TestProcessAttachment：增删改查（软删）供 TestInfo 管理过程附件

### 2.9 前端交付物（Vue + Element Plus + Pinia）
最终体验强制要求：
- **只有一个列表路由页面**：列表页内打开“统一抽屉”，抽屉里是 Tabs（EntryExit / TestInfo / DocApproval）
- 顶部有“闭环提示条（ClosureBar）”并支持“一键定位缺项”
- 列表展示 `is_closed`（只读来自后端，不实时计算）
- 行内编辑仅白名单用户可编辑，其他只读

### 2.10 验收点（Definition of Done）
1. 后端新增 `nvh_task` app 完整并挂载路由。
2. 所有模型具备软删除字段与默认过滤逻辑。
3. submit/unsubmit 正确刷新并落库 `MainRecord.is_closed`；EntryExit 影响其所有引用主任务。
4. 前端可从 BusinessCenter / MainLayout 入口进入模块。
5. 前端 Pinia 管理列表/抽屉/三表单/闭环提示条数据流。
6. 列表页只读 `is_closed`（不实时计算）。
7. **最终提交不包含 migration 文件**，但代码能通过 `makemigrations`（允许使用不落盘/临时生成后清理的方式自检）。

### 2.11 遇到不确定（执行规则）
- 先在仓库中搜索并参考现有实现（例如路由/Router/Serializer/请求封装的惯例）。
- 如果需求缺字段/缺接口：先提出澄清问题，再实现最小一致版本。
- 需求冲突时：以“强约束”章节为准，并在输出中说明取舍。

---

## 3. 执行清单：按步落地


### 后端任务 1/3：App 骨架 + 路由挂载
**改动范围**
- 新建：`backend/apps/nvh_task/`（`apps.py/models.py/serializers.py/services.py/views.py/urls.py` 等必要文件）
- 修改：`backend/nvh_backend/settings.py`（加入 INSTALLED_APPS）
- 修改：`backend/nvh_backend/urls.py`（挂载 `/api/nvh-task/`）

**完成条件**
- 项目能 import 新 app；路由挂载存在（接口可先返回 404/空实现）。

### 后端任务 2/3：models 全量落地 + 软删策略（保证可 makemigrations）
**改动范围**
- 只动：`backend/apps/nvh_task/models.py`

**完成条件**
- SoftDeleteModel 生效（默认查询不返回已删）。
- 全量业务模型字段/关系落地，`ImageField.upload_to` 统一在 `nvh_task/` 子目录下。
- `MainRecord.soft_delete` 级联软删 OneToOne；`TestInfo.soft_delete` 级联软删附件；`EntryExit.soft_delete` 引用>1 阻止删除并抛可读错误。

### 后端任务 3/3：DRF 接口 + serializers + services（筛选/软删/提交撤回/闭环）
**改动范围**
- `backend/apps/nvh_task/serializers.py`
- `backend/apps/nvh_task/services.py`
- `backend/apps/nvh_task/views.py`
- `backend/apps/nvh_task/urls.py`

**完成条件**
- list 支持分页 + 必须筛选字段。
- destroy 只软删。
- TestInfo/DocApproval 提供 `get_or_create` endpoint。
- submit/unsubmit 触发闭环刷新并落库（EntryExit 需刷新所有引用主任务）。
- serializer 返回 `active_mainrecord_count` 等前端所需字段。

---

### 前端任务 1/2：API 封装 + Pinia Store（先跑通数据流）
**改动范围（建议）**
- 新增：`frontend/src/api/nvh_task.js`
- 新增：`frontend/src/store/NVHtask.js`（导出 `useTaskStore`）

**完成条件**
- API 函数覆盖主列表、行内编辑、三表单 get_or_create、保存草稿、提交/撤回、附件增删改查。
- Store 管理：筛选/分页/列表数据/抽屉状态/Tabs lazy load/闭环提示条 missingItems 与定位信息。

### 前端任务 2/2：页面 + 路由 + 入口挂载（落地可用 UI）
**改动范围（建议拆分）**
- 列表路由页：`frontend/src/views/business/TaskMainList.vue`
- 抽屉容器：`frontend/src/views/business/components/TaskDetailDrawer.vue`
- Tabs：`frontend/src/views/business/components/tabs/EntryExitTab.vue`
- Tabs：`frontend/src/views/business/components/tabs/TestInfoTab.vue`
- Tabs：`frontend/src/views/business/components/tabs/DocApprovalTab.vue`
- 闭环提示条：`frontend/src/views/business/components/ClosureBar.vue`
- 路由：`frontend/src/router/index.js`
- 入口：`frontend/src/views/BusinessCenter.vue`、以及菜单维护处（按项目实际结构）

**完成条件**
- 列表页：筛选区（至少 8 维）+ 表格 + 分页 + 抽屉；时间列显示 `YYYY-MM-DD`；`is_closed` 只读展示。
- 白名单用户可行内编辑并保存；非白名单只读。
- 抽屉 Tabs：首次进入 Tab 才调用对应 load（get_or_create）；dirty 状态关闭提示（最小可用）。
- 闭环提示条：展示三模块状态 + missingItems；点击缺项能切 Tab 并滚动定位到对应区域。
- 三个 Tab 都能完成：保存草稿 → 提交 → 撤回，并在提交/撤回后刷新闭环提示条与列表闭环状态。

---


