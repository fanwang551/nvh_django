# 整车溯源分析功能需求文档（修订版）

## 一、需求概述

### 核心功能
基于整车全谱检测数据，对用户选择的物质进行零件溯源分析，展示：
1. 整车检测的物质数据
2. 每种物质的气味污染物Top5来源零件（按Qij排序）
3. 每种物质的有机污染物Top5来源零件（按Wih排序）
4. 支持可选显示Qij、Wih、浓度等详细数值

---
## 二、代码位置

后端：在apps下的voc；
前端：在侧边菜单栏的车身数据中心下的溯源中心下新建一个菜单取名"物质分项溯源",文件夹位置”frontend/src/views/vehicle-data“，
同样使用vue+pinia; 同样需要以单独的标签打开
---

## 三、计算公式说明

### 1. 气味污染物阈稀释倍数 Qij
```
Qij = Cij / OTVj
```
- Cij：第i个零部件中第j种物质的浓度（μg/m³）
- OTVj：第j种物质的嗅阈值（Odor Threshold Value）

### 2. 挥发性有机物阈稀释倍数 Wih
```
Wih = Cih / TVh
```
- Cih：第i个零部件中第h种VOC的浓度（μg/m³）
- TVh：第h种VOC的有机物阈值

---

## 四、前端UI设计

### **1. 整体页面布局**

```
┌─────────────────────────────────────────────────────────────┐
│                      筛选区（紧凑型）                        │
│  车型: [F410S ▼]  物质: [多选框] [查询]                     │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│              溯源分析结果表（响应式表格）                    │
│  （横向滚动，固定前5列，支持列显示控制）                     │
└─────────────────────────────────────────────────────────────┘
```

---

### **2. 筛选区设计**

#### 布局方案
```
┌──────────────────────────────────────────────────────────────┐
│  车型选择: [F410S ▼]                                          │
│                                                              │
│  物质选择: [带搜索的多选下拉框 ▼]  已选: 25种  [清空]        │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ 🔍 搜索物质（中文名/英文名/CAS号）                      │ │
│  │ ☑ 甲苯 (Toluene, 108-88-3)                             │ │
│  │ ☑ 乙苯 (Ethylbenzene, 100-41-4)                        │ │
│  │ □ 二甲苯 (Xylene, 1330-20-7)                           │ │
│  │ ... (支持虚拟滚动，显示所有可选物质)                    │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│                                      [查询溯源结果]          │
└──────────────────────────────────────────────────────────────┘
```

#### 交互细节
- **车型选择**：单选下拉框，默认显示第一个车型
- **物质选择**：
  - 下拉框内物质按**整车检测浓度值从高到低**排序
  - 显示格式：`中文名 (英文名, CAS号)`
  - 支持模糊搜索三个字段
  - 下拉框底部显示"已选择 X 种物质"
  - 支持快捷操作：全选、反选、清空
- **查询按钮**：
  - 未选择物质时置灰
  - 点击后显示加载状态（"查询中..."）

---

### **3. 溯源结果表设计**

#### **A. 表格整体布局**

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  F410S 整车溯源分析结果（共25种物质）                                                                    显示列设置 ▼              │
│                                                                                                         ┌──────────────────┐       │
│                                                                                                         │ ☐ Qij值          │       │
│                                                                                                         │ ☐ Wih值          │       │
│                                                                                                         │ ☐ 浓度值          │       │
│                                                                                                         └──────────────────┘       │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ [固定列区域 - 不滚动]                                │ [气味污染物来源区域 - 可滚动]      │ [有机污染物来源区域 - 可滚动]        │
│ 物质  保留 匹配 浓度  浓度                            │  排名1    排名2    排名3  ...      │  排名1    排名2    排名3  ...        │
│ 中文  时间 度   占比  (μg/m³)                        │  零件名  零件名  零件名            │  零件名  零件名  零件名              │
├─────────────────────────────────────────────────────┼───────────────────────────────────┼─────────────────────────────────────┤
│ 甲苯  12.3 95.6 8.5%  125.3                         │  方向盘  仪表板  座椅  门板  顶棚  │  方向盘  座椅  仪表板  门板  顶棚    │
├─────────────────────────────────────────────────────┼───────────────────────────────────┼─────────────────────────────────────┤
│ 乙苯  15.6 92.3 6.2%  89.0                          │  座椅    门板    方向盘  仪表板  - │  仪表板  方向盘  座椅  门板  地毯    │
├─────────────────────────────────────────────────────┼───────────────────────────────────┼─────────────────────────────────────┤
│ ...                                                 │  ...                              │  ...                                │
└─────────────────────────────────────────────────────┴───────────────────────────────────┴─────────────────────────────────────┘
                                                      ↑ 横向滚动条
```

---

#### **B. 表头设计（三级表头）**

##### **默认状态（仅显示零件名）**
```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                        全谱检测结果                │ 气味污染物可能来源 │ 挥发性有机污染物可能来源              │
│                        (整车检测数据)              │   (按Qij排序)     │     (按Wih排序)                      │
├────────┬────────┬──────┬────────┬────────┼─────┬─────┬─────┬─────┬─────┼─────┬─────┬─────┬─────┬─────┤
│ 物质   │ 保留   │ 匹配 │ 浓度   │ 浓度   │  1  │  2  │  3  │  4  │  5  │  1  │  2  │  3  │  4  │  5  │
│ 中文名 │ 时间   │ 度   │ 占比   │(μg/m³) │     │     │     │     │     │     │     │     │     │     │
└────────┴────────┴──────┴────────┴────────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘
```

##### **展开Qij和Wih后（隐藏浓度）**
```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                        全谱检测结果                │ 气味污染物可能来源 (按Qij排序)                │ 挥发性有机污染物可能来源 (按Wih排序)        │
│                        (整车检测数据)              │                                               │                                             │
├────────┬────────┬──────┬────────┬────────┼──────────────┬──────────────┬───────┼──────────────┬──────────────┬───────┤
│ 物质   │ 保留   │ 匹配 │ 浓度   │ 浓度   │  排名1       │  排名2       │  ...  │  排名1       │  排名2       │  ...  │
│ 中文名 │ 时间   │ 度   │ 占比   │(μg/m³) │ 零件 │ Qij  │ 零件 │ Qij  │       │ 零件 │ Wih  │ 零件 │ Wih  │       │
└────────┴────────┴──────┴────────┴────────┴──────┴──────┴──────┴──────┴───────┴──────┴──────┴──────┴──────┴───────┘
```

##### **全部展开（显示Qij、Wih、浓度）**
```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                        全谱检测结果                │ 气味污染物可能来源 (按Qij排序)                          │ 挥发性有机污染物可能来源 (按Wih排序)                  │
│                        (整车检测数据)              │                                                         │                                                       │
├────────┬────────┬──────┬────────┬────────┼────────────────────────┬────────────────────────┼────────────────────────┬────────────────────────┤
│ 物质   │ 保留   │ 匹配 │ 浓度   │ 浓度   │  排名1                 │  排名2                 │  排名1                 │  排名2                 │
│ 中文名 │ 时间   │ 度   │ 占比   │(μg/m³) │ 零件 │ Qij  │ 浓度    │ 零件 │ Qij  │ 浓度    │ 零件 │ Wih  │ 浓度    │ 零件 │ Wih  │ 浓度    │
└────────┴────────┴──────┴────────┴────────┴──────┴──────┴─────────┴──────┴──────┴─────────┴──────┴──────┴─────────┴──────┴──────┴─────────┘
```

---

#### **C. 列宽设计与响应式规则**

##### **固定列区域（左侧固定，不滚动）**
- 物质中文名：120px（固定）
- 保留时间：100px（固定）
- 匹配度：80px（固定）
- 浓度占比：90px（固定）
- 浓度：100px（固定）
- **总宽度：490px**

##### **可滚动区域（气味/有机污染物来源）**

**默认状态（仅零件名）**
- 每个排名位置：100px
- 5个排名 × 2个区域 = 1000px

**展开Qij/Wih（隐藏浓度）**
- 每个排名位置：零件名(100px) + Qij/Wih(80px) = 180px
- 5个排名 × 2个区域 × 180px = 1800px

**全部展开（Qij/Wih + 浓度）**
- 每个排名位置：零件名(100px) + Qij/Wih(80px) + 浓度(90px) = 270px
- 5个排名 × 2个区域 × 270px = 2700px

##### **响应式调整规则**
1. **固定列区域**：始终保持490px宽度，不参与响应式调整
2. **可滚动区域**：
   - 当隐藏列时，剩余列**等比例扩展**填充可用空间
   - 当显示列时，新增列**插入到对应位置**，其他列保持原宽度
   - 如果总宽度超过视口，启用横向滚动条

##### **列显示/隐藏的响应式行为**

| 显示状态 | 零件名列宽 | Qij/Wih列宽 | 浓度列宽 | 单个排名总宽 | 5个排名总宽 | 两区域总宽 |
|---------|-----------|------------|---------|------------|-----------|-----------|
| 仅零件名 | 100px | - | - | 100px | 500px | 1000px |
| 零件名+Qij/Wih | 100px | 80px | - | 180px | 900px | 1800px |
| 全部显示 | 100px | 80px | 90px | 270px | 1350px | 2700px |

---

#### **D. 单元格内容设计**

##### **固定列区域**
- **物质中文名**：完整显示，超长换行（最多2行）
- **保留时间**：保留2位小数，右对齐，格式：`12.34`
- **匹配度**：保留1位小数，右对齐，格式：`95.6`
- **浓度占比**：保留1位小数，右对齐，格式：`8.5`
- **浓度**：保留3位小数，右对齐，格式：`125.300`

##### **气味/有机污染物来源区域**

**零件名列**
- 显示完整零件名称（如"方向盘"）
- 超长文本换行（最多2行）
- 如果该排名位置无数据，显示 `-`
- **可点击**，点击后弹出详情弹窗

**Qij/Wih列**（可选显示）
- 保留2位小数，右对齐
- 格式：`457.30`
- 如果该排名位置无数据，显示 `-`
- 使用等宽字体（Consolas/Monaco）

**浓度列**（可选显示）
- 保留3位小数，右对齐
- 格式：`125.300`
- 如果该排名位置无数据，显示 `-`
- 使用等宽字体（Consolas/Monaco）

---

### **4. 列显示控制设计**

#### **A. 下拉菜单位置与样式**

```
┌─────────────────────────────────────────────────────────────┐
│  F410S 整车溯源分析结果（共25种物质）      显示列设置 ▼     │
│                                           ┌──────────────┐  │
│                                           │ ☐ Qij值      │  │
│                                           │ ☐ Wih值      │  │
│                                           │ ☐ 浓度值      │  │
│                                           └──────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  表格内容...                                                │
└─────────────────────────────────────────────────────────────┘
```

#### **B. 下拉菜单交互细节**

**位置**：表格标题栏右侧

**触发方式**：点击"显示列设置 ▼"按钮

**菜单内容**：
```
┌──────────────────────┐
│ ☐ Qij值              │  ← 控制气味污染物区域的Qij列
│ ☐ Wih值              │  ← 控制有机污染物区域的Wih列
│ ☐ 浓度值              │  ← 同时控制两个区域的浓度列
├──────────────────────┤
│ [全部显示] [全部隐藏] │  ← 快捷操作按钮
└──────────────────────┘
```

**默认状态**：
- Qij值：☐ 未选中（隐藏）
- Wih值：☐ 未选中（隐藏）
- 浓度值：☐ 未选中（隐藏）

**交互行为**：
1. 点击复选框立即生效，无需确认
2. 勾选后，对应列**从右侧插入**到零件名列后
3. 取消勾选后，对应列**淡出消失**，其他列响应式调整宽度
4. 点击菜单外区域自动关闭菜单
5. 用户的选择状态**保存到浏览器本地存储**，下次访问时恢复

**快捷操作**：
- **全部显示**：勾选所有复选框
- **全部隐藏**：取消所有复选框

---

### **5. 表格交互设计**

#### **A. 固定列功能**
- 物质中文名、保留时间、匹配度、浓度占比、浓度固定在左侧
- 横向滚动时，固定列始终可见
- 固定列与滚动区域之间有明显分隔线（2px实线 + 右侧阴影）

#### **B. 行交互**
- **悬浮效果**：鼠标悬停时整行高亮（背景色：#E6F7FF）
- **斑马纹**：奇数行白色，偶数行#FAFAFA

#### **C. 弹窗**
**表头字段**：
| 字段名 | 说明 |
|--------|------|
| 物质名称 | 中文名称，可点击 |
| 物质英文名 | |
| CAS号 | |
| 匹配度 | 百分比显示 |
| 保留时间 | 单位：分钟 |
| 浓度占比(%) | |
| 浓度(μg/m³) | |
**交互说明**：
- 点击「物质名称」：弹窗以卡片形式展示物质详细信息（包含物质库中的所有字段）
复用"D:\pythonProject\zlbbses\nvh_django\frontend\src\views\vehicle-data\SubstancesData.vue"中的实现
### **6. 视觉设计规范**

#### **A. 颜色方案**
- **表头背景**：
  - 全谱检测结果：#F0F5FF（浅蓝）
  - 气味污染物来源：#FFF7E6（浅橙）
  - 有机污染物来源：#F6FFED（浅绿）
- **行背景**：斑马纹（奇数行#FFFFFF，偶数行#FAFAFA）
- **悬浮高亮**：#E6F7FF
- **固定列分隔线**：2px实线 #D9D9D9 + 右侧阴影 `box-shadow: 2px 0 4px rgba(0,0,0,0.1)`
- **零件名可点击状态**：
  - 默认：文字颜色 #1890FF
  - 悬浮：文字颜色 #40A9FF + 下划线

#### **B. 字体规范**
- **表头**：14px 加粗，行高 22px
- **数据行**：13px 常规，行高 20px
- **数字列**：等宽字体（Consolas, Monaco, 'Courier New'）
- **零件名**：常规字体，可点击时添加下划线

#### **C. 间距规范**
- **单元格内边距**：8px 12px
- **行高**：48px
- **表头高度**：
  - 第一级（区域标题）：60px
  - 第二级（列标题）：48px
  - 第三级（子列标题，展开Qij/Wih/浓度时）：40px

#### **D. 动画效果**
- **列显示/隐藏**：
  - 显示：从右侧淡入 + 宽度展开（300ms ease-out）
  - 隐藏：淡出 + 宽度收缩（200ms ease-in）
- **行悬浮**：背景色渐变（150ms ease）
- **下拉菜单**：淡入淡出（200ms ease）

---

### **3. 数据组装**
将整车数据、气味污染物Top5、有机污染物Top5组装成响应格式。

---

## 七、用户体验优化

### **1. 加载状态**
```
查询中...
┌─────────────────────────────────┐
│   正在分析整车检测数据...        │
│   ████████░░░░░░░░░░ 40%        │
│                                 │
│   正在计算零件溯源排名...        │
└─────────────────────────────────┘
```

### **2. 空状态**
```
┌─────────────────────────────────┐
│         📊                      │
│   暂无数据                       │
│   请选择车型和物质后查询          │
└─────────────────────────────────┘
```




