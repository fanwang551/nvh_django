🚗 车身VOC贡献度分析接口需求文档
🔧 模块路径

apps/vehicle_body/
🖥️ 前端页面

frontend/src/views/vehicle-data/ContributionQuery.vue
🎯 当前任务
为 ContributionQuery.vue 实现后端 API 接口，支持根据用户选择的 "项目名-委托单号-样品编号" 查询并计算该项目下零部件的GOi与GVi贡献度，返回 排名前25 的结果。
✅ 前端界面保持不变，仅需提供符合其数据结构预期的 RESTful 接口。
💡 参考实现：可借鉴 apps/voc 模块的数据处理流程，但接口命名与业务语义必须贴合“车身”场景。

📥 请求输入
参数格式
用户从前端选择一个选项，形如：

"项目名-委托单号-样品编号"
例如："F123-1-1"
后端解析规则
提取 项目名 作为主筛选条件（即 project_name = 'F123'）
忽略委托单号与样品编号（仅为前端展示用途，不参与查询）
⚠️ 所有属于该项目名下的样品均纳入计算范围。

🧩 数据来源与模型关系

主要涉及以下模型表（假设已存在）：

表名 字段说明
------ --------
SampleInfo 样品表，含字段：project_name, part_name等
SubstancesTestDetail 物质检测详情表，外键关联 SampleInfo，qij='气味阈稀释倍数 Qij' wih='有机物阈稀释倍数 Wih'
✅ 一个 Sample → 多个 SubstancesTestDetail 记录

🔍 数据筛选规则

仅保留满足以下条件的样品记录：

python
project_name == {提取的项目名}
AND part_name != '整车'
AND SubstancesTestDetail 关联记录存在
📌 示例：选择 "F123-1-1" → 筛选所有 project_name='F123' 且零件名非“整车”的有效样品。
如果零件数不足35需要提示，可参考 apps/voc 中的实现只是筛选条件改变
🧮 贡献度计算流程
步骤 1：逐样品计算基础指标

对每个符合条件的样品 s 中的每条 detail in s.substances_test_details.all()：

公式 字段名 说明
------ ------- ------
Qij = Cij / OTVj qij 单个物质在零部件中的相对超标比
Wih = Cih / TVh wih 单个物质在整车中的相对超标比
✅ 这两个值存储于 SubstancesTestDetail 实例中，在查询时即时计算或预存均可。

步骤 2：汇总每个样品的 Oi 和 Vi

对于每个样品 s：

python
Oi = sum(detail.qij for detail in s.substances_test_details.all() if detail.qij is not None)
Vi = sum(detail.wih for detail in s.substances_test_details.all() if detail.wih is not None)
📌 得到每个样品的总偏离指数 Oi 和 Vi

步骤 3：按【零件名称】聚合不同阶段数据（去重合并）

目标：同一零件（如“仪表板”）在 A样、B样等多个阶段可能有多个 Oi 值，需合并为一条记录。
处理方式：
1. 按 part_name 分组所有同项目的样品。
2. 对每组内的所有 Oi 取算术平均：
python
avg_Oi = mean([s.Oi for s in samples_of_part])

3. 同理计算 avg_Vi = mean([s.Vi ...])
✅ 最终得到每个零件唯一的 avg_Oi 和 avg_Vi

步骤 4：全局归一化，计算最终贡献度
计算 ZOi 与 ZVi
python
ZOi = sum(avg_Oi for all parts in the project) # 所有零件 avg_Oi 的总和
ZVi = sum(avg_Vi for all parts in the project) # 所有零件 avg_Vi 的总和
计算贡献度百分比
python
GOi = (avg_Oi / ZOi) 100% # 零部件在项目中的 VOC 贡献率（基于零部件侧）
GVi = (avg_Vi / ZVi) 100% # 零部件在项目中的 VOC 贡献率（基于整车侧）
✅ 若 ZOi=0 或 ZVi=0，则对应贡献度设为 0.00%

📤 返回结果结构

接口返回 JSON 格式数据，包含两个排序列表（各取 Top 25），按贡献度降序排列。

json
{
"goi_ranking": [
{
"rank": 1,
"part_name": "顶棚",
"goi": 18.76
},
{
"rank": 2,
"part_name": "地毯",
"goi": 15.32
}
// ... 最多25项
],
"gvi_ranking": [
{
"rank": 1,
"part_name": "地毯",
"gvi": 22.15
},
{
"rank": 2,
"part_name": "门板",
"gvi": 19.88
}
// ... 最多25项
]
}
✅ goi_ranking 和 gvi_ranking 独立排序
✅ 数值保留两位小数
✅ 不要求两列表零件一致（因 GOi/GVi 排名可能不同）

❓常见问题澄清
✅ 但在最终结果中，通过取 平均 Oi 再归一化，每个零件只保留一条记录，故呈现唯一 GOi。
📌 示例：
仪表板-A样: Oi = 150
仪表板-B样: Oi = 130
avg_Oi = 140
ZOi = 2800 → GOi = 140 / 2800 ≈ 5.00%
➡️ 结果中仅显示 "仪表板", GOi=5.00%


