# 动态数据分析功能需求文档

## 一、功能概述
在业务中心"其他"分类下新增"动态数据分析"功能，用于多测点、多工况的对比分析和信息展示。

## 二、文件位置
- **前端**：`frontend/src/views/business/DynamicStateAnalysis,vue`
- **后端**：`backend/apps/acoustic_analysis/`

## 三、功能流程

### 3.1 数据查询流程
用户依次选择：**车型 → 工况 → 测点**

### 3.2 数据展示

#### 3.2.1 曲线图展示（页面主体）
展示两个独立的曲线图区域：
根据DynamicNoiseData表的x_axis_type属性判断横轴单位
**1. 声压级曲线图**
- **横轴**：车速(km/h) 或 转速(rpm)
- **纵轴**：声压级 dB(A)
- **说明**：同一图表只能显示相同横轴类型的数据，支持多条曲线对比

**2. 语音清晰度曲线图**
- **横轴**：车速(km/h) 或 转速(rpm)
- **纵轴**：语音清晰度 %AI
- **说明**：同一图表只能显示相同横轴类型的数据，支持多条曲线对比

**图表交互：**
- 支持图例显示/隐藏
- 支持数据点悬浮提示


#### 3.2.2 数据列表

**表格列：**

| 列名 | 说明 | 宽度 |
|------|------|------|
| 车型 | 车型名称 | 120px |
| 工况 | 工况名称 | 150px |
| 测点 | 测点名称 | 150px |
| 横轴类型 | 车速/转速 | 100px |
| 详情操作 | 操作按钮组 | 280px |

**详情操作按钮：**

| 按钮 | 图标 | 交互方式 | 展示内容 | 加载时机 |
|------|------|---------|----------|---------|
| 频谱 | 📊 | 弹窗 | 三维频谱热力图 | 点击时加载 |
| 声音 | 🔊 | 内嵌播放器 | .wav音频文件 | 点击时加载 |
| 噪声分析 | 📈 | 弹窗 | 噪声分析图片 | 点击时加载 |

**性能优化：**
- 音频、频谱等大文件仅在用户点击按钮时才加载
- 列表支持分页，默认每页10条


## 四、数据模型设计

### 4.1 新增模型
```python
class DynamicNoiseData(models.Model):
    """动态噪声数据表"""
    
    vehicle_model_id = models.IntegerField(verbose_name='车型ID', db_index=True)
    condition_measure_point = models.ForeignKey(
        ConditionMeasurePoint,
        on_delete=models.CASCADE,
        verbose_name='工况测点'
    )
    class XAxisType(models.TextChoices):
        SPEED = 'speed', '车速'
        RPM = 'rpm', '转速'
        
    x_axis_type = models.CharField(
        max_length=20,
        choices=XAxisType.choices,
        verbose_name='横轴类型',
        db_index=True
    )
    sound_pressure_curve = models.JSONField(verbose_name='声压级曲线数据')
    # 数据格式: {"speed/rpm": [速度/转速数组], "dB(A)": [声压级数组]}
    
    speech_clarity_curve = models.JSONField(verbose_name='语音清晰度曲线数据')
    # 数据格式: {"speed/rpm": [速度/转速数组], "%AI": [清晰度数组]}
    
    noise_analysis_image = models.CharField(max_length=500, verbose_name='噪声分析图路径', blank=True)
    audio_file = models.CharField(max_length=500, verbose_name='音频文件路径(.wav)', blank=True)
    spectrum_file = models.CharField(max_length=500, verbose_name='三维频谱文件路径(.npz)', blank=True)
    
    
    class Meta:
        verbose_name = '动态噪声数据'
        verbose_name_plural = verbose_name
        unique_together = ['vehicle_model_id', 'condition_measure_point']
```

## 五、数据说明

### 5.1 三维频谱数据
**源文件格式**：Excel
**源文件格式（Excel）：**
```
frequency| 0    | 20   | 40   | 60   | 80   | 100  | 120  |  ← 车速/转速
--------|------|------|------|------|------|------|------|
100 Hz  | 45.2 | 48.5 | 52.1 | 55.8 | 58.2 | 56.5 | 54.3 |
500 Hz  | 50.3 | 53.8 | 57.2 | 60.5 | 63.1 | 61.8 | 59.5 |
1000 Hz | 55.1 | 58.5 | 62.3 | 65.8 | 68.2 | 66.5 | 64.1 |
...     | ...  | ...  | ...  | ...  | ...  | ...  | ...  |
↑
频率
```
  
- **存储格式**：.npz文件（NumPy压缩格式）
数据库中存储的路径是.npz文件，不是excel文件
```
# 动态数据分析功能 UI 草图

## 一、主页面布局
```
车型选择框可以参考SteadyStateAnalysis.vue界面的选择框设计
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│  ┌─ 查询条件 ────────────────────────────────────────────────────────┐  │
│  │                                                                   │  │
│  │  车型: []  工况: []  测点: []           [ 查询 ]  [ 重置 ]            │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌─ 曲线图展示 ──────────────────────────────────────────────────────┐  │
│  │                                                                   │  │
│  │  ┌─ 声压级曲线 ─────────────────────────────────────────────┐    │  │
│  │  │                                                           │    │  │
│  │  │  声压级(dB)                                               │    │  │
│  │  │   85├─────────────────────────────────────────────       │    │  │
│  │  │     │              ╱────╲                                │    │  │
│  │  │   80├───────╱────╱      ╲────╲                          │    │  │
│  │  │     │      ╱                   ╲                         │    │  │
│  │  │   75├────╱                      ╲────                    │    │  │
│  │  │     │                                                    │    │  │
│  │  │   70├────────────────────────────────────────────        │    │  │
│  │  │     └────┬────┬────┬────┬────┬────┬────┬────            │    │  │
│  │  │          0   20   40   60   80  100  120  140           │    │  │
│  │  │                      车速(km/h) / 转速(rpm)              │    │  │
│  │  └───────────────────────────────────────────────────────┘    │  │
│  │                                                                   │  │
│  │  ┌─ 语音清晰度曲线 ─────────────────────────────────────────┐    │  │
│  │  │                                                           │    │  │
│  │  │  清晰度(%)                                                │    │  │
│  │  │  100├─────────────────────────────────────────────       │    │  │
│  │  │     │  ╲                                                 │    │  │
│  │  │   90├───╲────╲                                           │    │  │
│  │  │     │         ╲────╲                                     │    │  │
│  │  │   80├──────────────╲────╲                               │    │  │
│  │  │     │                    ╲────╲                          │    │  │
│  │  │   70├─────────────────────────╲────                     │    │  │
│  │  │     └────┬────┬────┬────┬────┬────┬────┬────            │    │  │
│  │  │          0   20   40   60   80  100  120  140           │    │  │
│  │  │                      车速(km/h) / 转速(rpm)              │    │  │
│  │  └───────────────────────────────────────────────────────┘    │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌─ 数据列表 ────────────────────────────────────────────────────────┐  │
│  │                                                                   │  │
│  │  ┌─────┬──────┬──────────┬─────────────────────────────────┐    │  │
│  │  │ 车型 │ 工况  │  测点     │           详情操作              │    │  │
│  │  ├─────┼──────┼──────────┼─────────────────────────────────┤    │  │
│  │  │ A型 │ 匀速60│ 驾驶员右耳│ [频谱] [🔊声音] [噪声分析]      │    │  │
│  │  ├─────┼──────┼──────────┼─────────────────────────────────┤    │  │
│  │  │ A型 │ 匀速80│ 驾驶员右耳│ [频谱] [🔊声音] [噪声分析]      │    │  │
│  │  ├─────┼──────┼──────────┼─────────────────────────────────┤    │  │
│  │  │ A型 │ 怠速  │ 驾驶员右耳│ [频谱] [🔊声音] [噪声分析]      │    │  │
│  │  └─────┴──────┴──────────┴─────────────────────────────────┘    │  │
│  │                                                                   │  │
│  │                                    共 3 条  [1] 2 3 >            │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 二、频谱弹窗（热力图）
根据DynamicNoiseData表的x_axis_type属性判断单位是speed或者rpm
```
┌─────────────────────────────────────────────────────────────────────┐
│  频谱分析 - A型 匀速60 驾驶员右耳                          [✕]      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─ 频谱热力图 ──────────────────────────────────────────────────┐ │
│  │                                                               │ │
│  │  车速/转速                                                    │ │
│  │  (km/h)                                                       │ │
│  │   140├─────────────────────────────────────────────   色标（纵向显示│ │
│  │      │ ░░░░ ▒▒▒▒ ▓▓▓▓ ████ ▓▓▓▓ ▒▒▒▒ ░░░░                   │ │
│  │   120├─────────────────────────────────────────────          │ │
│  │      │ ░░░░ ▒▒▒▒ ████ ████ ████ ▓▓▓▓ ▒▒▒▒                   │ │
│  │   100├─────────────────────────────────────────────          │ │
│  │      │ ▒▒▒▒ ▓▓▓▓ ████ ████ ████ ████ ▓▓▓▓                   │ │
│  │    80├─────────────────────────────────────────────          │ │
│  │      │ ▒▒▒▒ ████ ████ ████ ████ ████ ████                   │ │
│  │    60├─────────────────────────────────────────────          │ │
│  │      │ ▓▓▓▓ ████ ████ ████ ████ ████ ████                   │ │
│  │    40├─────────────────────────────────────────────          │ │
│  │      │ ████ ████ ████ ████ ████ ████ ▓▓▓▓                   │ │
│  │    20├─────────────────────────────────────────────          │ │
│  │      │ ████ ████ ████ ████ ▓▓▓▓ ▒▒▒▒ ░░░░                   │ │
│  │     0├─────────────────────────────────────────────          │ │
│  │      └──┬────┬────┬────┬────┬────┬────┬────┬──              │ │
│  │        100  500  1k   2k   4k   8k  12k  16k                │ │
│  │                      频率(Hz)                                │ │
│  │                                                               │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                     │
│                                                        [ 关闭 ]      │
└─────────────────────────────────────────────────────────────────────┘
```

## 三、噪声分析弹窗

```
┌─────────────────────────────────────────────────────────────────────┐
│  噪声分析 - A型 匀速60 驾驶员右耳                          [✕]      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  
│                    ┌─────────────────────┐                      │
│                    │                     │                      │
│                    │                     │                      │
│                    │   噪声分析图片展示     │                      │
│                    │                     │                      │
│                    │   (PNG/JPG格式)     │                        │
│                    │                     │                      │
│                    │                     │                      │
│                    └─────────────────────┘                      │
│                                                                  │
│                                                                     │
│                                                        [ 关闭 ]      │
└─────────────────────────────────────────────────────────────────────┘
```

## 四、音频播放（内嵌播放器）

```
┌─────────────────────────────────────────────────────────────────────┐
│  数据列表                                                           │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────┬──────┬──────────┬─────────────────────────────────────┐  │
│  │ 车型 │ 工况  │  测点     │           详情操作                  │  │
│  ├─────┼──────┼──────────┼─────────────────────────────────────┤  │
│  │ A型 │ 匀速60│ 驾驶员右耳│ [频谱] [🔊声音] [噪声分析]          │  │
│  ├─────┴──────┴──────────┴─────────────────────────────────────┤  │
│  │  ┌─ 音频播放器 ─────────────────────────────────────────┐   │  │
│  │  │  🔊 driver_right_ear_60kmh.wav                       │   │  │
│  │  │  ▶ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 🔊  │   │  │
│  │  │  0:00 ────────────────────────────────────── 0:45   │   │  │
│  │  └──────────────────────────────────────────────────┘   │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │ A型 │ 匀速80│ 驾驶员右耳│ [频谱] [🔊声音] [噪声分析]          │  │
│  └─────┴──────┴──────────┴─────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

