
## 后端任务 1/3：App 骨架 + 路由挂载（先让项目能识别模块）
**目标**
- 项目能跑起来、能 import 新 app。

**改动范围**
1. 新建目录：`backend/apps/nvh_task/`（文件齐全，但可以先写空壳）
   - `__init__.py`
   - `apps.py`
   - `models.py`（先放 SoftDelete 基类 + STATUS 常量，业务模型可先空或先声明）
   - `serializers.py`（空壳）
   - `services.py`（空壳）
   - `views.py`（空壳）
   - `urls.py`（先定义 urlpatterns）
2. 修改 `backend/nvh_backend/settings.py`
   - `INSTALLED_APPS` 加入：`backend.apps.nvh_task`（或按你项目的 app path 习惯：通常是 `apps.nvh_task`，看 experience 的写法）
3. 修改 `backend/nvh_backend/urls.py`
   

**验收点**
- 不验证

---

## 后端任务 2/3：models 全量落地 + 软删策略
**目标**
- 你需求里最硬的部分：**SoftDeleteModel + 全量业务模型**一次性写完。

**改动范围**
- 只动：`backend/apps/nvh_task/models.py`
- 放入：
  1) 软删除基类（SoftDeleteQuerySet/Manager/Model）
  2) `STATUS_DRAFT / STATUS_SUBMITTED`
  3) 全量业务模型：EntryExit/MainRecord/TestInfo/TestProcessAttachment/TestProcessList/DocApproval
  4) soft_delete 级联策略（MainRecord 删除级联软删 OneToOne；EntryExit 引用>1 禁删；TestInfo 删除级联软删附件）


**验收点**
- 不用验证，修改代码即可

---

## 后端任务 3/3：DRF 接口 + serializers + services（闭环/提交撤回/筛选/软删）
**目标**
- 把“可对接的 API”一次性交付给前端：列表筛选分页、三表单 get_or_create、submit/unsubmit、软删、闭环刷新落库规则。

**改动范围**
1. `backend/apps/nvh_task/serializers.py`
   - EntryExitSerializer：包含 `active_mainrecord_count`
   - MainRecordSerializer：包含 entry_exit/test_info/doc_approval 的状态摘要字段（用于前端闭环提示条）
   - ImageField：读写兼容（至少读能给出可访问 URL；写能接受字符串相对路径或空）
2. `backend/apps/nvh_task/services.py`
   - 按要求封装：
     - `refresh_main_closed`
     - `refresh_mains_closed_by_entry_exit`
     - `submit/unsubmit` for EntryExit/TestInfo/DocApproval
   - 提交校验三类（TestInfo/DocApproval/EntryExit）
3. `backend/apps/nvh_task/views.py`
   - ViewSet + actions：
     - MainRecord：list（带筛选字段）、create、retrieve、patch（entry_exit_id 变化触发 refresh_main_closed）、destroy（soft_delete）
     - EntryExit：CRUD + destroy（捕获 ValidationError 转 400）+ submit/unsubmit（刷新所有引用 main_records）
     - TestInfo：`GET main-record/{id}/test-info/` get_or_create + update + submit/unsubmit
     - DocApproval：同上
     - TestProcessAttachment：增删改查（软删）供 TestInfoForm 管理过程附件
4. `backend/apps/nvh_task/urls.py`
   - 参考 `experience/urls.py` 的写法（你们项目很可能是 router 注册 viewset）

**验收点（给前端的“接口合同”）**
- 主列表接口：支持分页 + 必须筛选字段（车型/VIN/预警/合同号/时间范围/提出人/测试人员/是否闭环）
- destroy：不物理删除（只 is_deleted=True）
- submit/unsubmit：调用后会刷新并落库 main.is_closed（EntryExit 影响所有引用任务）
- `GET main-records/{id}/test-info/` 不存在会创建 DRAFT 并返回
- `GET main-records/{id}/doc-approval/` 同上

---

下面是**按“最终版 UI：列表 + 统一抽屉 Tabs + 闭环一致体验”**重写后的前端任务清单，仍然拆成 **2 个任务**（先跑通数据流，再落地可用 UI）。路径/命名可按你项目实际结构微调，但核心交互与数据流要对齐新需求。

---

# 前端任务 1/2：API 封装 + Pinia Store（对齐“统一抽屉 + Tabs + 闭环提示条”数据流）
## 目标
- 先把 **列表筛选分页**、**行内编辑保存**、**统一抽屉打开后的三表单数据加载（lazy）**、**保存草稿/提交/撤回**、**EntryExit 共享绑定**、**闭环提示条所需状态与缺项列表** 跑通。

---

## 改动范围
### 1) 新增 `frontend/src/api/nvh_task.js`
参考 `frontend/src/api/experience.js`，使用 `utils/request.js` 封装接口（命名示例，可按后端实际 URL 调整）：

#### Main Records（列表/编辑/删除）
- `fetchMainRecords(params)`：支持筛选+分页（至少覆盖 8 维筛选）
- `patchMainRecord(id, payload)`：行内编辑保存（排程/地点/备注/测试人员等）
- `createMainRecord(payload)`：新增主记录（仅安排人员）
- `deleteMainRecord(id)`：删除（仅安排人员）

#### EntryExit（共享对象：get_or_create + 选择已有 + 绑定 + 草稿/提交/撤回）
- `getOrCreateEntryExit(main_id)`：返回 entry_exit 数据、status、active_mainrecord_count、shared_mainrecords 简要列表等
- `updateEntryExit(entry_exit_id, payload)`：保存草稿
- `submitEntryExit(entry_exit_id)` / `unsubmitEntryExit(entry_exit_id)`
- `searchEntryExits(params)`：选择已有（按 VIN/编号/时间/接收人等）
- `bindEntryExit(main_id, entry_exit_id)`：主任务绑定已有 entry_exit（绑定后刷新闭环状态）

#### TestInfo（1 对 1：get_or_create + 草稿/提交/撤回 + 过程附件）
- `getOrCreateTestInfo(main_id)`
- `updateTestInfo(test_info_id, payload)`
- `submitTestInfo(test_info_id)` / `unsubmitTestInfo(test_info_id)`

#### DocApproval（1 对 1：get_or_create + 草稿/提交/撤回 + 文件上传）
- `getOrCreateDocApproval(main_id)`
- `updateDocApproval(doc_approval_id, payload)`
- `submitDocApproval(doc_approval_id)` / `unsubmitDocApproval(doc_approval_id)`

#### Attachments（过程记录/拆装记录/技术资料文件等）
- `uploadAttachment(formData)` / `deleteAttachment(id)` / `listAttachments(params)`
> 说明：若后端已按业务拆分（例如 `test-info/attachments`、`doc-approval/file`），这里跟随后端实际接口封装即可，但 Store 层要统一管理附件数量与闭环缺项判断所需字段。

---

### 2) 新增 `frontend/src/store/NVHtask.js`（导出 `useTaskStore`）
Store 需要围绕“**列表页 + 统一抽屉（Tabs）**”组织状态与 action。

#### 2.1 全局用户信息
- 从 `frontend/src/store/index.js` 获取 `username/fullname`（按你项目现有方式适配）
- 明确白名单逻辑（必须出现）：
  - `canScheduleEdit = ['w1234','w1235'].includes(username)`

#### 2.2 列表状态（筛选 + 分页 + 列表数据）
- `filters`：至少包含 UI 强制的 8 个维度（建议字段名示例）  
  1) model（车型）  
  2) vin_or_part_no（VIN/零件编号）  
  3) test_name（试验名称）  
  4) tester_names（测试人员，多选/模糊）  
  5) schedule_range（开始/结束）  
  6) is_closed（闭环状态）  
  7) warning_status（预警状态，多选）  
  8) requester_name / contract_no（放更多筛选也行，但数据层要支持）
- `pagination`：`page/page_size/total`
- `mainList`：列表数据
- action：
  - `fetchList()`：带 filters + pagination 拉取
  - `resetFilters()`：重置后自动 fetchList

#### 2.3 行内编辑（仅安排人员）
- `editableFields`：限定排程相关字段（排期、测试人员、地点、备注等）
- action：
  - `saveInline(main_id, patch)`：内部检查 `canScheduleEdit`，否则直接拒绝（前端提示）
  - 保存成功后更新列表行；失败回滚（Store 保留 oldRow 快照或在组件层处理）

#### 2.4 统一抽屉状态（关键：Tabs + lazy load + 未保存提示）
- `drawer`：
  - `visible`
  - `main_id`
  - `mainRowSnapshot`（用于标题区：车型/VIN/试验名称、排期、测试人员等）
- `activeTab`：`'entry_exit' | 'test_info' | 'doc_approval'`
- 每个 Tab 独立状态（示例）：
  - `entryExit: { loading, id, status, form, sharedInfo, dirty }`
  - `testInfo: { loading, id, status, form, attachmentsSummary, dirty }`
  - `docApproval: { loading, id, status, form, fileInfo, dirty }`
- action：
  - `openDrawer(mainRow)`：设置 drawer + 拉取“闭环提示条所需摘要”（见下），并按规则决定默认 Tab
  - `closeDrawer()`：若存在 dirty，返回“未保存提示”给组件决定是否确认关闭
  - `switchTab(tabKey)`：lazy load（首次进入才 get_or_create）

#### 2.5 “闭环提示条”统一状态（必须能驱动：缺项列表 + 一键定位）
Store 提供一个**统一计算结果**（尽量由后端返回 status/计数，前端只组合展示）：

- `closureBar`（建议 computed/getter 形态）包含：
  - 三模块提交状态：entry_exit/test_info/doc_approval 的 `status`（DRAFT/SUBMITTED/EMPTY…）
  - 关键附件计数：例如  
    - `teardown_required + teardown_attachment_count`  
    - `process_required + process_attachment_count`  
    - `doc_file_uploaded` / `doc_file_url`
  - `is_closed`（列表里是后端给的，只读显示；抽屉内可同时显示“当前闭环缺项”）
  - `missingItems[]`：每条缺项结构必须包含：
    - `key`（唯一标识）
    - `label`（如“缺少：试验过程记录表图片（至少1张）”）
    - `targetTab`（entry_exit/test_info/doc_approval）
    - `anchor`（用于滚动定位到 Tab 内区域，如 `'process-attachments'`）

- action：
  - `refreshClosure(main_id)`：在提交/撤回/绑定后调用，刷新状态与 missingItems

#### 2.6 三表单动作（草稿/提交/撤回/绑定）
- EntryExit：
  - `loadEntryExit()`（get_or_create）
  - `searchEntryExitCandidates(keyword/filters)`
  - `bindExistingEntryExit(entry_exit_id)`（绑定后 refreshClosure + 可能刷新 TestInfo 来源字段）
  - `saveEntryExitDraft()` / `submitEntryExit()` / `unsubmitEntryExit()`
- TestInfo：
  - `loadTestInfo()`
  - `saveTestInfoDraft()` / `submitTestInfo()` / `unsubmitTestInfo()`
  - `uploadProcessAttachment()` / `deleteProcessAttachment()` 等（按你后端模型映射）
- DocApproval：
  - `loadDocApproval()`
  - `saveDocApprovalDraft()` / `submitDocApproval()` / `unsubmitDocApproval()`
  - `uploadDocFile()`（或走通用 uploadAttachment）

---

## 验收点（任务 1）
- 在任意临时页面/控制台能打印：
  - `mainList` 拉到数据（含分页 total）
  - `openDrawer(row)` 后能拿到 closureBar（含 missingItems 列表）
- 调用 store action：
  - `submit/unsubmit` 任一表单后，`refreshClosure` 能得到**新状态**与新的 missingItems
- 白名单逻辑明确且可用：`['w1234','w1235'].includes(username)`  
  非白名单调用 `saveInline` 会被拒绝并给出明确提示

---

---

# 前端任务 2/2：页面 + 路由挂载（落地“列表 + 统一抽屉 Tabs + 闭环提示条 + 一键定位”可用 UI）
## 目标
- 用户从菜单进入“试验任务管理”：
  - 筛选 + 分页列表
  - 显示 `is_closed`（只读，不在前端实时计算）
  - 安排人员支持行内编辑并保存
  - 点击【填写/查看表单】打开**右侧统一抽屉**（Tabs：进出登记/试验信息/技术资料）
  - 抽屉顶部**闭环提示条**能显示缺项，点击缺项能跳转对应 Tab 并滚动定位

---

## 改动范围
### 1) 新增/调整页面与组件（建议这样拆，满足“统一抽屉 Tabs”）
> 重点：**不要做三个独立路由页面**；三表单应在**同一个抽屉 Tabs**里。

- 列表页（唯一路由页面）  
  - `frontend/src/views/business/TaskMainList.vue`
- 统一抽屉容器组件（可内联在列表页，也可拆组件）  
  - 建议新增：`frontend/src/views/business/components/TaskDetailDrawer.vue`
- Tabs 三个内容组件（非路由）  
  - `frontend/src/views/business/components/tabs/EntryExitTab.vue`
  - `frontend/src/views/business/components/tabs/TestInfoTab.vue`
  - `frontend/src/views/business/components/tabs/DocApprovalTab.vue`
- 闭环提示条组件（sticky）  
  - `frontend/src/views/business/components/ClosureBar.vue`

#### UI 必须实现的关键点
- **列表页结构**：筛选区 + 表格 + 分页 + 抽屉
- **所有时间列显示 YYYY-MM-DD**
- 筛选区至少包含 8 维筛选（与任务1一致）
- 表格列至少显示：闭环状态（Badge）、预警、车型、VIN/零件编号、试验名称、测试人员、任务提出人、排期（开始~结束合并）、地点、操作
- 表格中展示 `is_closed`：只读，来自后端
- 行内编辑：
  - 仅白名单用户可编辑：排期/测试人员/地点/备注
  - 保存成功 Toast；失败回滚
- 操作列统一入口：
  - 【填写/查看表单】→ 打开抽屉（不跳转页面）

#### 抽屉（统一容器）必须实现
- Header：
  - 标题：`{车型} / {VIN/零件编号} / {试验名称}`
  - 闭环状态 Badge（已闭环/未闭环）
  - 显示排期、测试人员（只读）
- Body：
  - 顶部 sticky：`ClosureBar`（始终可见）
  - 下方 Tabs：进出登记 / 试验信息 / 技术资料
- Tab 默认打开规则：
  1) 未闭环：定位到 closureBar.missingItems 的第一条对应 Tab  
  2) 已闭环：默认 TestInfo（或记住上次 tab）
- Lazy load：
  - 第一次进入某 Tab 才调用对应 `loadXxx()`（get_or_create）
- 未保存提示：
  - Tab 内有 dirty 时关闭抽屉给确认（实现最小可用即可）

#### 闭环提示条（ClosureBar）必须实现
- 显示三模块状态（未提交/已提交）
- 显示关键缺项摘要（missingItems 列表）
- 点击缺项：
  - 自动切换到对应 Tab
  - 滚动到对应 anchor 区域（最小实现：`document.querySelector([data-anchor])?.scrollIntoView()`）
  - 对区域高亮（可用 class 临时加 1~2 秒）

---

### 2) EntryExit Tab（共享对象）必须实现的交互最小闭环
- 若主任务未绑定 `entry_exit_id`：
  - 显示“新建/选择已有”两种方式（radio）
  - 选择已有：提供搜索 + 列表选择 + 只读预览 +【确认绑定】
- 若已绑定：
  - 显示 `active_mainrecord_count`，并提示“编辑会影响 X 个任务”（最小实现：文字提示；可加二次确认）
- 提供按钮：
  -【保存草稿】【提交】【撤回提交】（是否显示按 status 控制）

---

### 3) TestInfo Tab 必须实现的交互最小闭环
- 展示来源字段（只读）：能从 main + entry_exit 派生（entry_exit 缺失显示 `--` 并提示先完成进出登记）
- 支持关键勾选与附件：
  - include_teardown_record = 是 → 要能上传拆装附件（至少 1）
  - include_process_record = 是 → 要能新增过程记录条目并上传图片（至少 1）
- 按钮：【保存草稿】【提交】【撤回提交】
- 提交后刷新 closureBar（立即更新缺项/状态）

---

### 4) DocApproval Tab 必须实现的交互最小闭环
- 核心字段 + 文件上传（file_url 或图片）
- 按钮：【保存草稿】【提交】【撤回提交】
- 提交要求文件已上传（由后端校验为主，前端可做提示）

---

### 5) 路由挂载：`frontend/src/router/index.js`
- 增加 route 指向 `TaskMainList.vue`（例如 `/business/nvh-task`）

### 6) 入口挂载
- `frontend/src/views/BusinessCenter.vue`：增加入口卡片/按钮 → 跳转到新路由
- 菜单维护处（如 `frontend/src/components/layout/MainLayout.vue` 或 SideMenu 配置处）增加菜单项：**试验任务管理**

---

## 页面验收点（任务 2）
- 从菜单进入页面能看到：
  - 筛选区（至少 8 维）+ 查询/重置 + 分页
  - 列表中 `is_closed` 正确展示（只读）
- 白名单用户可行内编辑并保存；非白名单只读
- 点击【填写/查看表单】打开**统一抽屉**（Tabs）
- 抽屉顶部闭环提示条展示缺项；点击缺项：
  - 自动切换 Tab
  - 能滚动到对应区域（最小可用）
- 三个 Tab 都能完成：get_or_create → 保存草稿 → 提交 → 撤回  
  且每次提交/撤回后闭环提示条状态能刷新更新

---



## 执行顺序建议（就是你要的“先做哪边”）
按上面的拆分，推荐顺序严格是：

1) 后端任务1 → 2) 后端任务2 → 3) 后端任务3 → 4) 前端任务1 → 5) 前端任务2


---

